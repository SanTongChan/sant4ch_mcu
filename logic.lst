C51 COMPILER V9.01   LOGIC                                                                 07/03/2017 16:14:30 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE LOGIC
OBJECT MODULE PLACED IN logic.obj
COMPILER INVOKED BY: F:\Program Files\Keil\C51\BIN\C51.EXE code\logic\logic.c BROWSE INCDIR(.\code\key;.\code\logic;.\co
                    -de\timer;.\code\driver;.\code\led;.\code\common) DEBUG OBJECTEXTEND PRINT(.\logic.lst) OBJECT(logic.obj)

line level    source

   1          #include <intrins.h>
   2          #include "logic.h"
   3          #include "N76E003.h"
   4          #include "key.h"
   5          #include "led.h"
   6          #include "timer.h"
   7          #include "key_driver.h"
   8          
   9          sbit RCK = P1^7;
  10          sbit SCK = P1^6;
  11          sbit SER = P3^0;
  12          
  13          bool led_blink_flag = false;
  14          bool key_scan_flag = false;
  15          bool update_local_flag = false;
  16          bool deal_jogging = false;
  17          bool deal_lock = false;
  18          bool syn_app_flag = false;
  19          
  20          uint8_t code relay_array[4] = {0x80,0x40,0x20,0x10};
  21          uint8_t code key_array[4] = {0x04,0x02,0x01,0x08};
  22          
  23          DevDef xdata dev_def = {0};
  24          uint16_t jogging_cnt = 0;
  25          static void h595Init(void)
  26          {
  27   1          //初始化P16 P17 P30为推挽输出
  28   1          P1M1 &= 0x3f;
  29   1              P1M2 |= 0Xc0;
  30   1              P3M1 &= 0xfe;
  31   1          P3M2 |= 0x01;
  32   1          SER = 1;
  33   1      }
  34          static void relayInit(void)
  35          {
  36   1          P0M1 |= 0x0f;//初始化relay脚 P00 -> P03     为输入
  37   1              P0M2 &= 0Xf0;  
  38   1      }
  39          static void syncApp(void)
  40          {
  41   1          uint8_t last_key = h595_val;
  42   1          uint8_t relays[4] = {0};
  43   1          uint8_t i = 0;
  44   1          relays[0] = RELAY1;
  45   1          relays[1] = RELAY2;
  46   1          relays[2] = RELAY3;
  47   1          relays[3] = RELAY4;
  48   1          if(dev_def.lock)
  49   1          {
  50   2              static uint8_t lock_channel = 0;
  51   2              static uint8_t last_lock_channel = 0;
  52   2              static uint8_t last_relay_val[4] = {0};
  53   2              if(dev_def.dev_channel[0].update_flag 
  54   2                  || dev_def.dev_channel[1].update_flag 
C51 COMPILER V9.01   LOGIC                                                                 07/03/2017 16:14:30 PAGE 2   

  55   2                  || dev_def.dev_channel[2].update_flag
  56   2                  || dev_def.dev_channel[3].update_flag)
  57   2              {
  58   3                  return;
  59   3              }
  60   2              for(i = 0; i < 4;i++)
  61   2              {
  62   3                  if(relays[i] != last_relay_val[i] && relays[i] == 1)
  63   3                  {
  64   4                      lock_channel = i + 1;
  65   4                  }
  66   3                  last_relay_val[i] = relays[i];
  67   3              }
  68   2              if(last_lock_channel != lock_channel)
  69   2              {
  70   3                  last_lock_channel = lock_channel;
  71   3                  for(i = 0; i < 4; i++)
  72   3                  {
  73   4                      if(lock_channel == (i + 1))
  74   4                      {
  75   5                          h595_val &= 0x0f;
  76   5                          h595_val |= relay_array[i];
  77   5                      }
  78   4                  }
  79   3                  dev_def.dev_channel[0].update_flag = true;
  80   3                  dev_def.dev_channel[1].update_flag = true;
  81   3                  dev_def.dev_channel[2].update_flag = true;
  82   3                  dev_def.dev_channel[3].update_flag = true;
  83   3                  dev_def.update_local_cnt = 0;
  84   3              }
  85   2              else
  86   2              {
  87   3                  if(relays[lock_channel - 1])
  88   3                  {
  89   4                      if(!(h595_val & relay_array[lock_channel - 1]))
  90   4                      {
  91   5                          h595_val |= relay_array[lock_channel - 1];
  92   5                          dev_def.dev_channel[0].update_flag = true;
  93   5                          dev_def.dev_channel[1].update_flag = true;
  94   5                          dev_def.dev_channel[2].update_flag = true;
  95   5                          dev_def.dev_channel[3].update_flag = true;
  96   5                          dev_def.update_local_cnt = 0;
  97   5                      }
  98   4                     
  99   4                  }
 100   3                  else
 101   3                  {
 102   4                      if(h595_val & relay_array[lock_channel - 1])
 103   4                      {
 104   5                          h595_val &= ~relay_array[lock_channel - 1];
 105   5                          dev_def.dev_channel[0].update_flag = true;
 106   5                          dev_def.dev_channel[1].update_flag = true;
 107   5                          dev_def.dev_channel[2].update_flag = true;
 108   5                          dev_def.dev_channel[3].update_flag = true;
 109   5                          dev_def.update_local_cnt = 0;
 110   5                      }
 111   4                  }
 112   3              }
 113   2          }
 114   1          else
 115   1          {
 116   2              for(i =  0; i < 4; i++)
C51 COMPILER V9.01   LOGIC                                                                 07/03/2017 16:14:30 PAGE 3   

 117   2              {
 118   3                  if(dev_def.dev_channel[i].channel_mode == DEV_JOGGING)
 119   3                  {
 120   4                      dev_def.dev_channel[i].timer_cnt++;
 121   4                      if((h595_val & relay_array[i]))//如果relay1是按下的
 122   4                      {
 123   5                          if(dev_def.dev_channel[i].get_status == false)
 124   5                          {
 125   6                              dev_def.dev_channel[i].timer_cnt = 0;
 126   6                              dev_def.dev_channel[i].get_status = true;
 127   6                          }
 128   5                          if(dev_def.dev_channel[i].timer_cnt >= 7)
 129   5                          {
 130   6                              dev_def.dev_channel[i].timer_cnt = 0;
 131   6                              dev_def.dev_channel[i].get_status = false;
 132   6                              h595_val &= (~relay_array[i]);//关掉relay1
 133   6                              dev_def.dev_channel[i].update_flag = true;//允许更新标志位
 134   6                              dev_def.update_local_cnt = 0;
 135   6                              jogging_cnt = 0;
 136   6                          }
 137   5                      }
 138   4                  }
 139   3                  if(!dev_def.dev_channel[i].update_flag)
 140   3                  {
 141   4                      if(relays[i])
 142   4                      {
 143   5                          h595_val |= relay_array[i];
 144   5                      }
 145   4                      else
 146   4                      {
 147   5                          h595_val &= (~relay_array[i]);
 148   5                      }
 149   4                  }
 150   3              }
 151   2          }
 152   1          if(h595_val != last_key)
 153   1          {
 154   2              SendTo595(h595_val);
 155   2          }
 156   1      }
 157          static void updateLocal(void)
 158          {
 159   1          static bool high_flag[4] = {false};
 160   1          uint8_t i = 0;
 161   1          uint8_t last_key = h595_val;
 162   1          uint8_t relays[4] = {0};
 163   1          dev_def.update_local_cnt++;
 164   1          if(dev_def.update_local_cnt == 5)
 165   1          {
 166   2              relays[0] = (uint8_t)RELAY1;
 167   2              relays[1] = (uint8_t)RELAY2;
 168   2              relays[2] = (uint8_t)RELAY3;
 169   2              relays[3] = (uint8_t)RELAY4;
 170   2              for(i = 0; i < 4; i++)
 171   2              {
 172   3                  if(dev_def.dev_channel[i].update_flag)
 173   3                  {
 174   4                      if((relays[i] << (7 - i)) != (h595_val & relay_array[i]))
 175   4                      {
 176   5                          high_flag[i] = true;
 177   5                          h595_val &= ~key_array[i];
 178   5                      }
C51 COMPILER V9.01   LOGIC                                                                 07/03/2017 16:14:30 PAGE 4   

 179   4                      else
 180   4                      {
 181   5                          dev_def.dev_channel[i].update_flag = false;
 182   5                      }
 183   4                  }
 184   3              }
 185   2          }
 186   1          if(dev_def.update_local_cnt >= 6)
 187   1          {
 188   2              dev_def.update_local_cnt = 0;
 189   2              for(i = 0; i < 4; i++)
 190   2              {
 191   3                  if(high_flag[i] == true)
 192   3                  {
 193   4                      h595_val |= key_array[i];
 194   4                      high_flag[i] = false;
 195   4                  }
 196   3              }
 197   2          }
 198   1          if(h595_val != last_key)
 199   1          {
 200   2              SendTo595(h595_val);
 201   2          }
 202   1      }
 203          void dealLogic(void)
 204          {
 205   1          if(key_scan_flag)
 206   1          {
 207   2              key_scan_flag = false;
 208   2              keyScan();
 209   2          }
 210   1          if(syn_app_flag)
 211   1          {
 212   2              syn_app_flag = false;
 213   2              syncApp();
 214   2          }
 215   1          if(update_local_flag)
 216   1          {
 217   2              update_local_flag = false;
 218   2              updateLocal();//要在同步APP之后
 219   2          }
 220   1      }
 221          void logicInit(void)
 222          {
 223   1          h595Init();
 224   1          SendTo595(0x0f);
 225   1          ledInit();   
 226   1              keyInit();
 227   1          relayInit();
 228   1          timer0Init();
 229   1          dev_def.dev_channel[0].channel_mode = DEV_JOGGING;
 230   1          dev_def.dev_channel[1].channel_mode = DEV_JOGGING;
 231   1          dev_def.dev_channel[2].channel_mode = DEV_JOGGING;
 232   1          dev_def.dev_channel[3].channel_mode = DEV_JOGGING;
 233   1          dev_def.lock = false;
 234   1          MODE_LED = 0;
 235   1      }
 236          void SendTo595(uint8_t val)
 237          {
 238   1              char i=0;
 239   1              uint8_t temp = val;
 240   1              EA = 0;
C51 COMPILER V9.01   LOGIC                                                                 07/03/2017 16:14:30 PAGE 5   

 241   1              for(i = 0; i < 8; i++)
 242   1              {
 243   2                      SER = temp>>7;
 244   2                      temp= temp<<1;
 245   2                      SCK = 0;
 246   2                      _nop_();
 247   2                      SCK = 1;
 248   2              }
 249   1              RCK = 0;
 250   1              _nop_();
 251   1              RCK = 1;
 252   1              SER = 0;
 253   1              EA = 1;
 254   1      }
 255          
 256          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    861    ----
   CONSTANT SIZE    =     16    ----
   XDATA SIZE       =     22    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     18      11
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
